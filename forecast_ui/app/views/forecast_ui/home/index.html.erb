<div class="mx-auto p-4" style="width: 700px; max-width: 700px;">
  <h1 class="text-2xl font-bold mb-4">Forecast Lookup</h1>

  <%= form_with url: main_app.api_v1_forecasts_path(format: :json), method: :get, local: true, html: { id: "forecast-form" }, class: "space-y-4" do |f| %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="text" name="address[street]" placeholder="Street" />
      <input type="text" name="address[city]" placeholder="City" />
      <input type="text" name="address[state]" placeholder="State" />
      <input type="text" name="address[zip]" placeholder="Zip" />
      <%= f.select :unit, [["Unit System", ""], ["Metric", "metric"], ["Imperial", "imperial"]], {} %>
      <%= f.number_field :days, min: 1, max: 14, placeholder: "Days" %>
    </div>
    <%= f.submit "Get Forecast", class: "btn btn-primary mt-4" %>
  <% end %>

  <div id="forecast_results">
    <!-- Results will render here -->
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const form = document.getElementById("forecast-form");
      form.addEventListener("submit", function(event) {
        event.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams();
        for (const pair of formData.entries()) {
          params.append(pair[0], pair[1]);
        }
        
        // Show loading state
        fetch('/loading')
          .then(response => response.text())
          .then(html => {
            document.getElementById("forecast_results").innerHTML = html;
          });

        // Submit form data to forecasts endpoint
        fetch('/forecasts', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          },
          body: formData
        })
        .then(response => response.text())
        .then(html => {
          document.getElementById("forecast_results").innerHTML = html;
        })
        .catch(error => {
          document.getElementById("forecast_results").innerHTML = '<div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-800">Error: ' + error.message + '</p></div>';
        });
      });
    });
  </script>
</div>
